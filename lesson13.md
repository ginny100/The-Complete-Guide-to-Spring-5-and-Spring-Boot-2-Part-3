# Lesson 13: CRUD Operations

## Overview

The `EntityManager` offers a large number of methods to perform various queries. We can write methods to insert, fetch, update, and delete data.

## Demonstrated Concepts

### `merge` method for `INSERT` and `UPDATE` queries

The `EntityManager` offers a merge method for both `INSERT` and `UPDATE` operations. 

`merge` checks if the primary key value is being passed to it or not. If it finds the primary key, it _updates_ the corresponding record. If the primary key is not passed, it generates a value and _inserts_ a new record in the table. The `merge` method returns an object which has been updated or inserted.

```java
public Player insertPlayer(Player player) {
   return entityManager.merge(player);
}

public Player updatePlayer(Player player) {
   return entityManager.merge(player);
}
```

The `merge` method will create an SQL `INSERT` or `UPDATE` query and map values to it from the `Player` object on its own. It also converts the row returned to a `Player` object on its own.

### Executing a query

We use the `CommandLineRunner` interface to use the `run` method, just like we do with __Spring JDBC__.

In order to execute `insertPlayer`, we will autowire `PlayerRepository` in the `TennisPlayerApplication` class and use it to call methods in the `run` method:

```java
@Autowired
PlayerRepository repo;

@Override
public void run(String... args) throws Exception {
    logger.info("\n\n>> Inserting Player: {}\n", repo.insertPlayer(
                 new Player("Djokovic", "Serbia", Date.valueOf("1987-05-22"), 81)));

    logger.info("\n\n>> Inserting Player: {}\n", repo.insertPlayer(
                 new Player("Monfils", "France", Date.valueOf("1986-09-01"), 10)));
}
```

Notice that we are not passing the `Id` attribute as it will be auto-generated by Hibernate. The insertion can be confirmed from the H2 web console by executing the `SELECT *` query. Hibernate has assigned id 1 and 2 to the rows it inserted. The ids would be incremented in sequence if more rows are inserted.

### The `show-sql` property

To see the queries that Hibernate has generated, we can enable the `show-sql` property in the __application.properties__ file as follows:

```properties
spring.jpa.show-sql=true
```

### `find` method for `SELECT` query

`EntityManager` offers a number of `find` methods. We will pick the one that takes the name of the class and the primary key as arguments.

```java
public Player getPlayerById(int id) {
    return entityManager.find(Player.class, id);                
}
```

Like the `merge` method, the `find` method also creates the SQL query and maps values to it on its own. It also converts the row returned to a `Player` object.

We call `getPlayerById` in the `run` method:

```java
@Override
public void run(String... args) throws Exception {
    logger.info("\n\n>> Inserting Player: {}\n", repo.insertPlayer(
               new Player("Djokovic", "Serbia", Date.valueOf("1987-05-22"), 81)));
    logger.info("\n\n>> Inserting Player: {}\n", repo.insertPlayer(
               new Player("Monfils", "France", Date.valueOf("1986-09-01"), 10)));

    logger.info("\n\n>> Player with id 2: {}\n", repo.getPlayerById(2));
}
```

### `remove` method for `DELETE` query

The `remove` method of `EntityManager` is used to delete a row from the table. This is a two-step process: 
- First, we get the object using the `find` method by passing the id of the object we want to remove. 
- Then, we will pass the object to the `remove` method. 

`remove` is a `void` method and does not return anything.

```java
public void deleteById(int id){
    Player player = entityManager.find(Player.class, id);
    entityManager.remove(player);
}
```

When this method is called inside the `run` method, we can see the `DELETE` query generated by Hibernate. The delete can be confirmed from the H2 console using a `SELECT *` query.